<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Database - Salsa</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../mermaid.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../about_salsa.html"><strong aria-hidden="true">1.</strong> About salsa</a></li><li class="chapter-item expanded "><a href="../how_to_use.html"><strong aria-hidden="true">2.</strong> How to use Salsa</a></li><li class="chapter-item expanded "><a href="../how_salsa_works.html"><strong aria-hidden="true">3.</strong> How Salsa works</a></li><li class="chapter-item expanded "><a href="../common_patterns.html"><strong aria-hidden="true">4.</strong> Common patterns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../common_patterns/selection.html"><strong aria-hidden="true">4.1.</strong> Selection</a></li><li class="chapter-item expanded "><a href="../common_patterns/on_demand_inputs.html"><strong aria-hidden="true">4.2.</strong> On-demand (Lazy) inputs</a></li></ol></li><li class="chapter-item expanded "><a href="../videos.html"><strong aria-hidden="true">5.</strong> YouTube videos</a></li><li class="chapter-item expanded "><a href="../plumbing.html"><strong aria-hidden="true">6.</strong> Plumbing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../plumbing/query_groups.html"><strong aria-hidden="true">6.1.</strong> Query groups</a></li><li class="chapter-item expanded "><a href="../plumbing/database.html" class="active"><strong aria-hidden="true">6.2.</strong> Database</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Salsa</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#database" id="database">Database</a></h1>
<p>Continuing our dissection, the other thing which a user must define is a
<strong>database</strong>, which looks something like this:</p>
<pre><code class="language-rust ignore">#[salsa::database(HelloWorldStorage)]
#[derive(Default)]
struct DatabaseStruct {
    runtime: salsa::Runtime&lt;DatabaseStruct&gt;,
}

// Tell salsa where to find the runtime in your context.
impl salsa::Database for DatabaseStruct {
    fn salsa_runtime(&amp;self) -&gt; &amp;salsa::Runtime&lt;Self&gt; {
        &amp;self.runtime
    }

    fn salsa_runtime_mut(&amp;mut self) -&gt; &amp;mut salsa::Runtime&lt;Self&gt; {
        &amp;mut self.runtime
    }
}
</code></pre>
<p>The <code>salsa::database</code> procedural macro takes a list of query group
structs (like <code>HelloWorldStorage</code>) and generates the following items:</p>
<ul>
<li>a copy of the database struct it is applied to</li>
<li>a struct <code>__SalsaDatabaseStorage</code> that contains all the storage structs for
each query group. Note: these are the structs full of hashmaps etc that are
generaetd by the query group procdural macro, not the <code>HelloWorldStorage</code>
struct itself.</li>
<li>a struct <code>__SalsaDatabaseKey</code> that wraps an enum <code>__SalsaDatabaseKeyKind</code>. The
enum contains one variant per query group, and in each variant contains the
group key. This can be used to identify any query in the database.</li>
<li>an impl of <code>HasQueryGroup&lt;G&gt;</code> for each query group <code>G</code></li>
<li>an impl of <code>salsa::plumbing::DatabaseStorageTypes</code> for the database struct</li>
<li>an impl of <code>salsa::plumbing::DatabaseOps</code> for the database struct</li>
<li>an impl of <code>salsa::plumbing::DatabaseKey&lt;DB&gt;</code> for the database struct <code>DB</code></li>
</ul>
<h2><a class="header" href="#key-constraint-we-do-not-know-the-names-of-individual-queries" id="key-constraint-we-do-not-know-the-names-of-individual-queries">Key constraint: we do not know the names of individual queries</a></h2>
<p>There is one key constraint in the design here. None of this code knows the
names of individual queries. It only knows the name of the query group storage
struct. This means that we often delegate things to the group -- e.g., the
database key is composed of group keys. This is similar to how none of the code
in the query group knows the full set of query groups, and so it must use
associated types from the <code>Database</code> trait whenever it needs to put something in
a &quot;global&quot; context.</p>
<h2><a class="header" href="#the-database-storage-struct" id="the-database-storage-struct">The database storage struct</a></h2>
<p>The <code>__SalsaDatabaseStorage</code> struct concatenates all of the query group storage
structs. In the hello world example, it looks something like:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct __SalsaDatabaseStorage {
    hello_world: &lt;HelloWorldStorage as salsa::plumbing::QueryGroup&lt;DatabaseStruct&gt;&gt;::GroupStorage
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#the-database-key-struct--enum-and-the-databasekey-impl" id="the-database-key-struct--enum-and-the-databasekey-impl">The database key struct / enum and the <code>DatabaseKey</code> impl</a></h2>
<p>The <code>__SalsaDatabaseKey</code> and <code>__SalsaDatabaseKeyKind</code> types create a <strong>database
key</strong>, which uniquely identifies any query in the database. It builds on the
<strong>group keys</strong> created by the query groups, which uniquely identify a query
within a given query group.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct __SalsaDatabaseKey {
    kind: __SalsaDatabaseKeyKind
}

enum __SalsaDatabaseKeyKind {
    HelloWorld(
        &lt;HelloWorldStorage as salsa::plumbing::QueryGroup&lt;DatabaseStruct&gt;&gt;::GroupKey
    )
}
<span class="boring">}
</span></code></pre></pre>
<p>We also generate an impl of <code>DatabaseKey</code>:</p>
<pre><code class="language-rust ignore">    output.extend(quote! {
        impl salsa::plumbing::DatabaseKey&lt;#database_name&gt; for __SalsaDatabaseKey {
        }
    });
</code></pre>
<h2><a class="header" href="#the-hasquerygroup-impl" id="the-hasquerygroup-impl">The <code>HasQueryGroup</code> impl</a></h2>
<p>The <code>HasQueryGroup</code> trait allows a given query group to access its definition
within the greater database. The impl is generated here:</p>
<pre><code class="language-rust ignore">        has_group_impls.extend(quote! {
            impl salsa::plumbing::HasQueryGroup&lt;#group_path&gt; for #database_name {
                fn group_storage(db: &amp;Self) -&gt; &amp;#group_storage {
                    let runtime = salsa::Database::salsa_runtime(db);
                    &amp;runtime.storage().#group_name_snake
                }

                fn database_key(group_key: #group_key) -&gt; __SalsaDatabaseKey {
                    __SalsaDatabaseKey {
                        kind: __SalsaDatabaseKeyKind::#group_name(group_key),
                    }
                }
            }
        });
</code></pre>
<p>and so for our example it would look something like</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl salsa::plumbing::HasQueryGroup&lt;HelloWorld&gt; for DatabaseStruct {
    fn group_storage(&amp;self) -&gt; &amp;HelloWorldStorage::GroupStorage {
        &amp;self.hello_world
    }

    fn database_key(group_key: HelloWorldStorage::GroupKey) -&gt; __SalsaDatabaseKey {
        __SalsaDatabaseKey {
            kind: __SalsaDatabaseKeyKind::HelloWorld(group_key)
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#other-impls" id="other-impls">Other impls</a></h2>
<p>Then there are a variety of other impls, like this one for <code>DatabaseStorageTypes</code>:</p>
<pre><code class="language-rust ignore">    output.extend(quote! {
        impl salsa::plumbing::DatabaseStorageTypes for #database_name {
            type DatabaseKey = __SalsaDatabaseKey;
            type DatabaseStorage = __SalsaDatabaseStorage;
            type DatabaseData = (#(#database_data),*);
        }
    });
</code></pre>
<p>Or this one for <code>DatabaseOps</code>, which defines the for-each method to
invoke an operation on every kind of query in the database. It ultimately
delegates to the <code>for_each</code> methods for the groups:</p>
<pre><code class="language-rust ignore">    let mut for_each_ops = proc_macro2::TokenStream::new();
    for (QueryGroup { group_path }, group_storage) in
        query_groups.iter().zip(&amp;query_group_storage_names)
    {
        for_each_ops.extend(quote! {
            let storage: &amp;#group_storage =
                &lt;Self as salsa::plumbing::HasQueryGroup&lt;#group_path&gt;&gt;::group_storage(self);
            storage.for_each_query(self, &amp;mut op);
        });
    }
    output.extend(quote! {
        impl salsa::plumbing::DatabaseOps for #database_name {
            fn for_each_query(
                &amp;self,
                mut op: impl FnMut(&amp;dyn salsa::plumbing::QueryStorageMassOps&lt;Self&gt;),
            ) {
<span class="boring">                for_each_ops
</span>            }
        }
    });
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../plumbing/query_groups.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../plumbing/query_groups.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../mermaid-init.js"></script>
        

        

    </body>
</html>
